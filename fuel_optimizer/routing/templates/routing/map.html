<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Route Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/polyline"></script>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
}

.header {
    background: #0b3d91;
    color: #fff;
    padding: 12px 16px;
}

#map {
    height: calc(100vh - 52px);
    width: 100%;
}
</style>
</head>
<body>
<div class="header">Fuel Optimized Route Map</div>
<div id="map"></div>

<script>
const encodedPolyline = "{{ polyline|default_if_none:''|escapejs }}";
const fuelStops = JSON.parse("{{ fuel_stops|escapejs }}");
const startCoords = JSON.parse("{{ start_coords|escapejs }}"); // [lon, lat]
const endCoords = JSON.parse("{{ end_coords|escapejs }}");     // [lon, lat]

function lonLatToLatLng(coords) {
    if (!Array.isArray(coords) || coords.length < 2) {
        return null;
    }
    return [Number(coords[1]), Number(coords[0])];
}

const map = L.map("map").setView([39.5, -98.35], 4);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
}).addTo(map);

let bounds = L.latLngBounds();

if (encodedPolyline) {
    try {
        const decoded = polyline.decode(encodedPolyline, 5);
        const route = L.polyline(decoded, { color: "#1d4ed8", weight: 4 }).addTo(map);
        bounds.extend(route.getBounds());
    } catch (err) {
        console.warn("Could not decode route polyline", err);
    }
}

const startLatLng = lonLatToLatLng(startCoords);
const endLatLng = lonLatToLatLng(endCoords);

if (startLatLng) {
    L.marker(startLatLng).addTo(map).bindPopup("Start").openPopup();
    bounds.extend(startLatLng);
}
if (endLatLng) {
    L.marker(endLatLng).addTo(map).bindPopup("Finish");
    bounds.extend(endLatLng);
}

fuelStops.forEach((stop) => {
    const lat = Number(stop.latitude);
    const lon = Number(stop.longitude);
    if (Number.isNaN(lat) || Number.isNaN(lon)) {
        return;
    }
    const popup = `${stop.name}<br>${stop.city}, ${stop.state}<br>$${Number(stop.price).toFixed(3)}`;
    L.circleMarker([lat, lon], {
        radius: 6,
        color: "#dc2626",
        fillColor: "#ef4444",
        fillOpacity: 0.85
    }).addTo(map).bindPopup(popup);
    bounds.extend([lat, lon]);
});

if (bounds.isValid()) {
    map.fitBounds(bounds.pad(0.1));
}
</script>
</body>
</html>
